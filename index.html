<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Registro de Medidores de Agua - La Gran Manzana">
    <title>La Gran Manzana - Medidores</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // URL de tu Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkxOP9BhasIMpe_wQwz79G8SSwxm9Ok7VVv8WZxE0cFeF--1ra52u4T6l4skwIbS0Tcg/exec';

        // Iconos
        const Camera = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const LogOut = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeWidth={2} />
                <line x1="12" y1="8" x2="12" y2="12" strokeWidth={2} strokeLinecap="round" />
                <line x1="12" y1="16" x2="12.01" y2="16" strokeWidth={2} strokeLinecap="round" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Clock = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeWidth={2} />
                <polyline points="12 6 12 12 16 14" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth={2} />
                <line x1="16" y1="2" x2="16" y2="6" strokeWidth={2} strokeLinecap="round" />
                <line x1="8" y1="2" x2="8" y2="6" strokeWidth={2} strokeLinecap="round" />
                <line x1="3" y1="10" x2="21" y2="10" strokeWidth={2} />
            </svg>
        );

        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" strokeWidth={2} />
                <path d="m21 21-4.35-4.35" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const Wifi = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
            </svg>
        );

        const WifiOff = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="1" y1="1" x2="23" y2="23" strokeWidth={2} strokeLinecap="round" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16.72 11.06A10.94 10.94 0 0119 12.55M5 12.55a10.94 10.94 0 015.17-2.39M10.71 5.05A16 16 0 0122.58 9M1.42 9a15.91 15.91 0 014.7-2.88M8.53 16.11a6 6 0 016.95 0M12 20h.01" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 4 23 10 17 10" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                <polyline points="1 20 1 14 7 14" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const CloudUpload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const MedidorApp = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('login');
          const [locales, setLocales] = useState([]);
          const [selectedLocal, setSelectedLocal] = useState('');
          const [lectura, setLectura] = useState('');
          const [foto, setFoto] = useState(null);
          const [registros, setRegistros] = useState([]);
          const [error, setError] = useState('');
          const [success, setSuccess] = useState('');
          const [loading, setLoading] = useState(false);
          const [loginUsername, setLoginUsername] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [nombreGuardia, setNombreGuardia] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [isOnline, setIsOnline] = useState(navigator.onLine);
          const [syncStatus, setSyncStatus] = useState('');
          const [pendingSyncCount, setPendingSyncCount] = useState(0);

          const localesData = [
            {numero: "1-2-3-4-5", inquilino: "Ancla Izquierda", estado: "Vac√≠a", grupo: true},
            {numero: 6, inquilino: "Elizabeth Godoy"},
            {numero: 7, inquilino: "Elizabeth Godoy"},
            {numero: 8, inquilino: "Elizabeth Godoy"},
            {numero: 9, inquilino: "Elizabeth Godoy"},
            {numero: 10, inquilino: "Ama Importadora"},
            {numero: 11, inquilino: "Temperteck"},
            {numero: "12-13", inquilino: "Elizabeth Godoy", grupo: true},
            {numero: 14, inquilino: "Cecilia Moreno"},
            {numero: 15, inquilino: "Pacific Cargo"},
            {numero: 16, inquilino: "Dassconfort"},
            {numero: 17, inquilino: "Dassconfort"},
            {numero: 18, inquilino: "Jessica Aragon"},
            {numero: 19, inquilino: "Roger Echanique"},
            {numero: 20, inquilino: "Premiuntech"},
            {numero: 21, inquilino: "Premiuntech"},
            {numero: 22, inquilino: "Premiuntech"},
            {numero: 23, inquilino: "Aviauto"},
            {numero: 24, inquilino: "Frankimport"},
            {numero: 25, inquilino: "Equindeca"},
            {numero: 26, inquilino: "MedicHome"},
            {numero: 27, inquilino: "MedicHome"},
            {numero: 28, inquilino: "Aviauto"},
            {numero: 29, inquilino: "Aviauto"},
            {numero: 30, inquilino: "Mauricio Negrete"},
            {numero: 31, inquilino: "Dulcalab"},
            {numero: "32-33-34", inquilino: "Equindeca", grupo: true},
            {numero: 35, inquilino: "She"},
            {numero: 36, inquilino: "AutoCentrum"},
            {numero: 37, inquilino: "Ignacio Baque"},
            {numero: 38, inquilino: "Surtibell"},
            {numero: 39, inquilino: "Cendecom"},
            {numero: 40, inquilino: "Camembert"},
            {numero: 41, inquilino: "Bitelnet"},
            {numero: 42, inquilino: "Kaseruc"},
            {numero: 43, inquilino: "Gilbert Global"},
            {numero: 44, inquilino: "Gilbert Global"},
            {numero: 45, inquilino: "Patsy Perez"},
            {numero: 46, inquilino: "RecorDental"},
            {numero: 47, inquilino: "Elektorres"},
            {numero: 48, inquilino: "Innovamedikal"},
            {numero: 49, inquilino: "Innovamedikal"},
            {numero: "50-51-52", inquilino: "Jorge Vera", grupo: true},
            {numero: 53, inquilino: "Patricia Celleri"},
            {numero: 54, inquilino: "Imporfrio"},
            {numero: 55, inquilino: "Proteinas & Company"},
            {numero: 56, inquilino: "Corpkadilac"},
            {numero: 57, inquilino: "Corpkadilac"},
            {numero: "58-59", inquilino: "Kissu", grupo: true},
            {numero: 60, inquilino: "Bticino"},
            {numero: 61, inquilino: "Rigotech"},
            {numero: 62, inquilino: "Samsung"},
            {numero: 63, inquilino: "VentaMark"},
            {numero: 64, inquilino: "VentaMark"},
            {numero: 65, inquilino: "Qaltrom"},
            {numero: 66, inquilino: "Qaltrom"},
            {numero: 67, inquilino: "James Brown"},
            {numero: 68, inquilino: "James Brown"},
            {numero: 69, inquilino: "Coop. 27 de Noviembre"},
            {numero: 70, inquilino: "Beatriz Roman"},
            {numero: 71, inquilino: "Kaseruc"},
            {numero: 72, inquilino: "RecorDental"},
            {numero: 73, inquilino: "Corpkadilac"},
            {numero: "74-75", inquilino: "Innovamedikal", grupo: true},
            {numero: 76, inquilino: "Yessenia Fernandez"},
            {numero: "77-78", inquilino: "Corpkadilac", grupo: true},
            {numero: 79, inquilino: "Corpkadilac"},
            {numero: "80-81-82-83-84", inquilino: "Consorcio Gane", grupo: true},
            {numero: "85-86-87", inquilino: "Elvis Crespo", grupo: true},
            {numero: 88, inquilino: "Enterprise Motors"},
            {numero: 89, inquilino: "Enterprise Motors"},
            {numero: 90, inquilino: "Enterprise Motors"},
            {numero: 91, inquilino: "Karina Nazareno"},
            {numero: 92, inquilino: "Rapsecon"},
            {numero: 93, inquilino: "Rapsecon"},
            {numero: 94, inquilino: "FootCell"},
            {numero: "95-96-97", inquilino: "Sesinaqua", grupo: true},
            {numero: 98, inquilino: "Innovamedikal"},
            {numero: 99, inquilino: "ServiCar"},
            {numero: "100-101", inquilino: "Kissu", grupo: true},
            {numero: 102, inquilino: "Vac√≠o"},
            {numero: 103, inquilino: "TKVElectros"},
            {numero: 104, inquilino: "Schullo"},
            {numero: 105, inquilino: "Schullo"},
            {numero: 106, inquilino: "Barbara Adum"},
            {numero: 107, inquilino: "Envios Rapidos"},
            {numero: 108, inquilino: "Kaseruc"},
            {numero: 109, inquilino: "Camembert"},
            {numero: 110, inquilino: "Camembert"},
            {numero: 111, inquilino: "Andrea Naula"},
            {numero: 112, inquilino: "Norvida"},
            {numero: 113, inquilino: "Norvida"},
            {numero: 114, inquilino: "Norvida"},
            {numero: "115-116", inquilino: "Norvida", grupo: true},
            {numero: 117, inquilino: "Norvida"},
            {numero: 118, inquilino: "Norvida"},
            {numero: 119, inquilino: "Norvida"},
            {numero: 120, inquilino: "Norvida"},
            {numero: 121, inquilino: "Norvida"},
            {numero: 122, inquilino: "Norvida"},
            {numero: 123, inquilino: "Camembert"},
            {numero: 124, inquilino: "Ricardo Cede√±o"},
            {numero: 125, inquilino: "Jami"},
            {numero: 126, inquilino: "Sinpetsa"},
            {numero: 127, inquilino: "Vac√≠o"},
            {numero: 128, inquilino: "Vac√≠o"},
            {numero: 129, inquilino: "Rayos X"},
            {numero: 130, inquilino: "Distrimass"},
            {numero: 131, inquilino: "Pharmatotal"},
            {numero: 132, inquilino: "Pharmatotal"},
            {numero: 133, inquilino: "K'archer"},
            {numero: "R-CG", inquilino: "Riego Consorcio Gane"},
            {numero: "R-BM", inquilino: "Riego Banco de Miro"},
            {numero: "B-PUB", inquilino: "Ba√±os Publicos"},
            {numero: "B-EMP", inquilino: "Ba√±os de empleados"},
            {numero: "B-GAN", inquilino: "Ba√±os Gane"},
            {numero: "ML-L6", inquilino: "Medidor Limpieza (L6)"},
            {numero: "ML-L15", inquilino: "Medidor Limpieza (L15)"},
            {numero: "ML-L24", inquilino: "Medidor Limpieza (L24)"},
            {numero: "ML-L41", inquilino: "Medidor Limpieza (L41)"},
            {numero: "ML-L60", inquilino: "Medidor Limpieza (L60)"},
            {numero: "ML-L68", inquilino: "Medidor Limpieza (L68)"},
            {numero: "ML-L79", inquilino: "Medidor Limpieza (L79)"},
            {numero: "ML-L87", inquilino: "Medidor Limpieza (L87)"},
            {numero: "ML-L102", inquilino: "Medidor Limpieza (L102)"},
            {numero: "ML-L108", inquilino: "Medidor Limpieza (L108)"},
            {numero: "ML-L123", inquilino: "Medidor Limpieza (L123)"},
            {numero: "M-OFI", inquilino: "Contenedor 1 atr√°s Oficina"},
            {numero: "M-L49", inquilino: "Contenedor 2 atr√°s L49"},
            {numero: "M-BOM", inquilino: "Cuarto de Bombas"},
            {numero: "M-GEN", inquilino: "Medidor General"},
            {numero: "MAD-001", inquilino: "Medidor Adicional 001"},
            {numero: "MAD-002", inquilino: "Medidor Adicional 002"},
            {numero: "MAD-003", inquilino: "Medidor Adicional 003"}
          ];

          useEffect(() => {
            loadData();
            
            const handleOnline = () => {
              setIsOnline(true);
              sincronizarPendientes();
            };
            const handleOffline = () => setIsOnline(false);
            
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            const intervalSync = setInterval(() => {
              if (navigator.onLine) {
                sincronizarPendientes();
              }
            }, 30000);
            
            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
              clearInterval(intervalSync);
            };
          }, []);

          const loadData = () => {
            try {
              const initialLocales = localesData.map(l => ({
                ...l,
                ultimaLectura: 0,
                fechaUltimaLectura: null
              }));

              const localesStorage = localStorage.getItem('locales-gran-manzana');
              if (localesStorage) {
                const savedLocales = JSON.parse(localesStorage);
                savedLocales.forEach(saved => {
                  const local = initialLocales.find(l => String(l.numero) === String(saved.numero));
                  if (local && saved.ultimaLectura) {
                    local.ultimaLectura = saved.ultimaLectura;
                    local.fechaUltimaLectura = saved.fechaUltimaLectura;
                  }
                });
              }

              setLocales(initialLocales);

              const hoy = new Date().toISOString().split('T')[0];
              const registrosStorage = localStorage.getItem(`registros-${hoy}`);
              if (registrosStorage) {
                setRegistros(JSON.parse(registrosStorage));
              }

              contarPendientes();
            } catch (err) {
              console.error('Error cargando datos:', err);
              setLocales(localesData.map(l => ({
                ...l,
                ultimaLectura: 0,
                fechaUltimaLectura: null
              })));
            }
          };

          const contarPendientes = () => {
            try {
              const pendientes = localStorage.getItem('registros-pendientes');
              if (pendientes) {
                const lista = JSON.parse(pendientes);
                setPendingSyncCount(lista.length);
              } else {
                setPendingSyncCount(0);
              }
            } catch (err) {
              setPendingSyncCount(0);
            }
          };

          const sincronizarPendientes = async () => {
            if (!navigator.onLine) {
              return;
            }

            try {
              const pendientes = localStorage.getItem('registros-pendientes');
              if (!pendientes) return;

              const lista = JSON.parse(pendientes);
              if (lista.length === 0) return;

              setSyncStatus('Sincronizando...');

              const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(lista)
              });

              localStorage.removeItem('registros-pendientes');
              setPendingSyncCount(0);
              setSyncStatus('‚úì Sincronizado con Google Sheets');
              setTimeout(() => setSyncStatus(''), 3000);

            } catch (err) {
              console.error('Error sincronizando:', err);
              setSyncStatus('Error al sincronizar');
              setTimeout(() => setSyncStatus(''), 3000);
            }
          };

          const guardarRegistroLocal = (registro) => {
            try {
              const hoy = registro.fecha.split('T')[0];
              
              const registrosStorage = localStorage.getItem(`registros-${hoy}`);
              const registrosActuales = registrosStorage ? JSON.parse(registrosStorage) : [];
              registrosActuales.push(registro);
              localStorage.setItem(`registros-${hoy}`, JSON.stringify(registrosActuales));

              const pendientes = localStorage.getItem('registros-pendientes');
              const listaPendientes = pendientes ? JSON.parse(pendientes) : [];
              
              const registroParaSync = {
                id: registro.id,
                local: registro.local,
                inquilino: registro.inquilino,
                lectura: registro.lectura,
                guardia: registro.guardia,
                fecha: registro.fecha,
                username: registro.username,
                foto: registro.foto ? true : false
              };
              
              listaPendientes.push(registroParaSync);
              localStorage.setItem('registros-pendientes', JSON.stringify(listaPendientes));
              setPendingSyncCount(listaPendientes.length);

              if (navigator.onLine) {
                setTimeout(() => sincronizarPendientes(), 500);
              }

              return true;
            } catch (err) {
              console.error('Error guardando local:', err);
              return false;
            }
          };

          const handleLogin = () => {
            const usuarios = {
              'guardia': { password: '1234', rol: 'guardia' },
              'admin': { password: 'admin123', nombre: 'Administrador', rol: 'admin' }
            };

            if (loginUsername === 'guardia') {
              if (usuarios[loginUsername].password === loginPassword) {
                if (!nombreGuardia.trim()) {
                  setError('Por favor ingrese su nombre completo');
                  return;
                }
                setUser({ username: loginUsername, nombre: nombreGuardia.trim(), rol: 'guardia' });
                setView('registro');
                setError('');
                setLoginUsername('');
                setLoginPassword('');
                setNombreGuardia('');
              } else {
                setError('Contrase√±a incorrecta');
              }
            } else if (usuarios[loginUsername] && usuarios[loginUsername].password === loginPassword) {
              setUser({ username: loginUsername, ...usuarios[loginUsername] });
              setView(usuarios[loginUsername].rol === 'admin' ? 'admin' : 'registro');
              setError('');
              setLoginUsername('');
              setLoginPassword('');
            } else {
              setError('Usuario o contrase√±a incorrectos');
            }
          };

          const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
              if (file.size > 5000000) {
                setError('La foto es muy grande. M√°ximo 5MB');
                return;
              }
              const reader = new FileReader();
              reader.onloadend = () => {
                setFoto(reader.result);
                setError('');
              };
              reader.readAsDataURL(file);
            }
          };

          const validarLectura = () => {
            const local = locales.find(l => String(l.numero) === String(selectedLocal));
            const lecturaNum = parseFloat(lectura);

            if (!selectedLocal) return 'Debe seleccionar un local';
            if (!lectura || isNaN(lecturaNum)) return 'Debe ingresar una lectura v√°lida';
            if (local.ultimaLectura && lecturaNum < local.ultimaLectura) {
              return `La lectura no puede ser menor a la anterior (${local.ultimaLectura})`;
            }
            if (local.ultimaLectura && lecturaNum > local.ultimaLectura + 1000) {
              return `La lectura parece muy alta. Anterior: ${local.ultimaLectura}, Nueva: ${lecturaNum}. ¬øEst√° seguro?`;
            }

            const hoy = new Date().toISOString().split('T')[0];
            const yaRegistrado = registros.find(r => 
              String(r.local) === String(selectedLocal) && 
              r.fecha.split('T')[0] === hoy
            );
            if (yaRegistrado) return 'Este local ya fue registrado hoy';

            return null;
          };

          const handleSubmit = () => {
            setLoading(true);
            setError('');
            setSuccess('');

            const errorValidacion = validarLectura();
            if (errorValidacion) {
              setError(errorValidacion);
              setLoading(false);
              return;
            }

            try {
              const ahora = new Date().toISOString();
              const hoy = ahora.split('T')[0];
              const lecturaNum = parseFloat(lectura);
              const localData = locales.find(l => String(l.numero) === String(selectedLocal));

              const nuevoRegistro = {
                id: Date.now(),
                local: selectedLocal,
                inquilino: localData.inquilino,
                lectura: lecturaNum,
                foto: foto,
                fecha: ahora,
                guardia: user.nombre,
                username: user.username
              };

              const guardado = guardarRegistroLocal(nuevoRegistro);
              
              if (!guardado) {
                setError('Error al guardar el registro localmente');
                setLoading(false);
                return;
              }

              const nuevosRegistros = [...registros, nuevoRegistro];
              setRegistros(nuevosRegistros);

              const localesActualizados = locales.map(l => 
                String(l.numero) === String(selectedLocal)
                  ? { ...l, ultimaLectura: lecturaNum, fechaUltimaLectura: ahora }
                  : l
              );
              localStorage.setItem('locales-gran-manzana', JSON.stringify(localesActualizados));
              setLocales(localesActualizados);

              setSuccess(`‚úì Local ${selectedLocal} - ${localData.inquilino} registrado correctamente`);
              setSelectedLocal('');
              setLectura('');
              setFoto(null);
              setSearchTerm('');
              
              const fileInput = document.getElementById('foto-input');
              if (fileInput) fileInput.value = '';

            } catch (err) {
              setError('Error al guardar el registro: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const exportarExcel = () => {
            const hoy = new Date().toISOString().split('T')[0];
            
            let csv = 'Fecha;Hora;Local;Inquilino;Lectura (m¬≥);Guardia;Tiene Foto\n';
            
            const registrosOrdenados = [...registros].sort((a, b) => {
              const getNumero = (local) => {
                const match = String(local).match(/\d+/);
                return match ? parseInt(match[0]) : 9999;
              };
              return
              return getNumero(a.local) - getNumero(b.local);
            });
            
            registrosOrdenados.forEach(r => {
              const fecha = new Date(r.fecha);
              const fechaStr = fecha.toLocaleDateString('es-EC');
              const horaStr = fecha.toLocaleTimeString('es-EC');
              const tieneFoto = r.foto ? 'S√≠' : 'No';
              
              const limpiar = (texto) => {
                texto = String(texto).replace(/;/g, ',');
                return texto;
              };
              
              csv += `${fechaStr};${horaStr};${limpiar(r.local)};${limpiar(r.inquilino)};${r.lectura};${limpiar(r.guardia)};${tieneFoto}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lecturas-gran-manzana-${hoy}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          };

          const calcularProgreso = () => {
            const hoy = new Date().toISOString().split('T')[0];
            const registrosHoy = registros.filter(r => r.fecha.split('T')[0] === hoy);
            return {
              completados: registrosHoy.length,
              total: locales.length,
              porcentaje: Math.round((registrosHoy.length / locales.length) * 100)
            };
          };

          const filteredLocales = locales.filter(local => {
            const search = searchTerm.toLowerCase();
            return (
              String(local.numero).toLowerCase().includes(search) ||
              local.inquilino.toLowerCase().includes(search)
            );
          });

          if (!user) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
                  <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">La Gran Manzana</h1>
                    <p className="text-gray-600">Sistema de Registro de Medidores</p>
                    <div className="mt-3 flex items-center justify-center gap-2">
                      {isOnline ? (
                        <span className="flex items-center gap-1 text-green-600 text-sm">
                          <Wifi className="w-4 h-4" />
                          Conectado
                        </span>
                      ) : (
                        <span className="flex items-center gap-1 text-orange-600 text-sm">
                          <WifiOff className="w-4 h-4" />
                          Sin conexi√≥n (Modo Offline)
                        </span>
                      )}
                    </div>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                      <input
                        type="text"
                        value={loginUsername}
                        onChange={(e) => setLoginUsername(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ingrese su usuario"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                      <input
                        type="password"
                        value={loginPassword}
                        onChange={(e) => setLoginPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ingrese su contrase√±a"
                      />
                    </div>

                    {loginUsername === 'guardia' && (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Nombre y Apellido *</label>
                        <input
                          type="text"
                          value={nombreGuardia}
                          onChange={(e) => setNombreGuardia(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Ej: Juan P√©rez"
                        />
                      </div>
                    )}

                    {error && (
                      <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-start gap-2">
                        <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                        <span className="text-sm">{error}</span>
                      </div>
                    )}

                    <button
                      onClick={handleLogin}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors"
                    >
                      Iniciar Sesi√≥n
                    </button>
                  </div>

                  <div className="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                    <p className="font-semibold mb-2">Usuarios:</p>
                    <p><strong>Guardias:</strong> guardia (contrase√±a: 1234)</p>
                    <p className="text-xs text-gray-500 mt-1">* Despu√©s de ingresar usuario y contrase√±a, escriba su nombre completo</p>
                    <p className="mt-2"><strong>Admin:</strong> admin (contrase√±a: admin123)</p>
                  </div>

                  <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                    <p className="font-semibold mb-1">üí° Modo Offline Habilitado</p>
                    <p>Esta app funciona sin internet. Los datos se sincronizan autom√°ticamente cuando hay conexi√≥n.</p>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'admin') {
            const progreso = calcularProgreso();
            const hoy = new Date().toISOString().split('T')[0];
            const registrosHoy = registros.filter(r => r.fecha.split('T')[0] === hoy);

            return (
              <div className="min-h-screen bg-gray-50 p-4">
                <div className="max-w-7xl mx-auto">
                  <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div className="flex justify-between items-center mb-4">
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">Panel Administrativo</h1>
                        <p className="text-gray-600">Bienvenido, {user.nombre}</p>
                      </div>
                      <div className="flex items-center gap-3">
                        {isOnline ? (
                          <span className="flex items-center gap-1 text-green-600 text-sm">
                            <Wifi className="w-4 h-4" />
                          </span>
                        ) : (
                          <span className="flex items-center gap-1 text-orange-600 text-sm">
                            <WifiOff className="w-4 h-4" />
                          </span>
                        )}
                        <button
                          onClick={() => { setUser(null); setView('login'); }}
                          className="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                        >
                          <LogOut className="w-4 h-4" />
                          Salir
                        </button>
                      </div>
                    </div>

                    {syncStatus && (
                      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        {syncStatus}
                      </div>
                    )}

                    {pendingSyncCount > 0 && (
                      <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2 text-yellow-800">
                            <CloudUpload className="w-5 h-5" />
                            <span className="text-sm font-medium">
                              {pendingSyncCount} registros pendientes de sincronizar
                            </span>
                          </div>
                          <button
                            onClick={sincronizarPendientes}
                            disabled={!isOnline}
                            className="flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-400 text-white rounded-lg transition-colors text-sm"
                          >
                            <RefreshCw className="w-4 h-4" />
                            Sincronizar ahora
                          </button>
                        </div>
                      </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Calendar className="w-8 h-8 text-blue-600" />
                          <div>
                            <p className="text-sm text-gray-600">Fecha</p>
                            <p className="text-xl font-bold text-gray-800">{new Date().toLocaleDateString()}</p>
                          </div>
                        </div>
                      </div>

                      <div className="bg-green-50 p-4 rounded-lg">
                        <div className="flex items-center gap-3">
                          <CheckCircle className="w-8 h-8 text-green-600" />
                          <div>
                            <p className="text-sm text-gray-600">Registrados Hoy</p>
                            <p className="text-xl font-bold text-gray-800">{progreso.completados} / {progreso.total}</p>
                          </div>
                        </div>
                      </div>

                      <div className="bg-purple-50 p-4 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Clock className="w-8 h-8 text-purple-600" />
                          <div>
                            <p className="text-sm text-gray-600">Progreso</p>
                            <p className="text-xl font-bold text-gray-800">{progreso.porcentaje}%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="mb-4">
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div
                          className="bg-blue-600 h-4 rounded-full transition-all duration-500"
                          style={{ width: `${progreso.porcentaje}%` }}
                        ></div>
                      </div>
                    </div>

                    <button
                      onClick={exportarExcel}
                      disabled={registrosHoy.length === 0}
                      className="flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors font-semibold"
                    >
                      <Download className="w-5 h-5" />
                      Exportar a Excel ({registrosHoy.length} registros)
                    </button>
                    
                    {registrosHoy.length > 0 && (
                      <p className="text-sm text-gray-600 mt-2">
                        El archivo se descargar√° con todas las columnas organizadas para abrir en Excel. 
                        Los datos tambi√©n est√°n en Google Sheets.
                      </p>
                    )}
                  </div>

                  <div className="bg-white rounded-lg shadow-lg p-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Registros de Hoy</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Local</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Inquilino</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Lectura</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Hora</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Guardia</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Foto</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {registrosHoy.length === 0 ? (
                            <tr>
                              <td colSpan="6" className="px-4 py-8 text-center text-gray-500">
                                No hay registros para hoy
                              </td>
                            </tr>
                          ) : (
                            registrosHoy
                              .sort((a, b) => {
                                const getNumero = (local) => {
                                  const match = String(local).match(/\d+/);
                                  return match ? parseInt(match[0]) : 9999;
                                };
                                return getNumero(a.local) - getNumero(b.local);
                              })
                              .map(r => (
                                <tr key={r.id} className="hover:bg-gray-50">
                                  <td className="px-4 py-3 text-sm font-medium text-gray-900">{r.local}</td>
                                  <td className="px-4 py-3 text-sm text-gray-700">{r.inquilino}</td>
                                  <td className="px-4 py-3 text-sm text-gray-700">{r.lectura} m¬≥</td>
                                  <td className="px-4 py-3 text-sm text-gray-700">
                                    {new Date(r.fecha).toLocaleTimeString()}
                                  </td>
                                  <td className="px-4 py-3 text-sm text-gray-700">{r.guardia}</td>
                                  <td className="px-4 py-3">
                                    {r.foto ? (
                                      <img src={r.foto} alt="Medidor" className="w-16 h-16 object-cover rounded cursor-pointer" 
                                           onClick={() => window.open(r.foto, '_blank')} />
                                    ) : (
                                      <span className="text-xs text-gray-400">Sin foto</span>
                                    )}
                                  </td>
                                </tr>
                              ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          const progreso = calcularProgreso();

          return (
            <div className="min-h-screen bg-gray-50 p-4">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <div className="flex justify-between items-center mb-6">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-800">Registro de Medidores</h1>
                      <p className="text-gray-600">Hola, {user.nombre}</p>
                    </div>
                    <div className="flex items-center gap-3">
                      {isOnline ? (
                        <span className="flex items-center gap-1 text-green-600 text-sm">
                          <Wifi className="w-4 h-4" />
                        </span>
                      ) : (
                        <span className="flex items-center gap-1 text-orange-600 text-sm">
                          <WifiOff className="w-4 h-4" />
                        </span>
                      )}
                      <button
                        onClick={() => { setUser(null); setView('login'); }}
                        className="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                      >
                        <LogOut className="w-4 h-4" />
                        Salir
                      </button>
                    </div>
                  </div>

                  {syncStatus && (
                    <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                      {syncStatus}
                    </div>
                  )}

                  {pendingSyncCount > 0 && !isOnline && (
                    <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                      <div className="flex items-center gap-2">
                        <CloudUpload className="w-5 h-5" />
                        <span>{pendingSyncCount} registros se sincronizar√°n cuando haya internet</span>
                      </div>
                    </div>
                  )}

                  <div className="bg-blue-50 p-4 rounded-lg mb-6">
                    <p className="text-sm text-gray-700 mb-2">Progreso de hoy: {progreso.completados} / {progreso.total} locales</p>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div
                        className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                        style={{ width: `${progreso.porcentaje}%` }}
                      ></div>
                    </div>
                  </div>

                  {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-start gap-2 mb-4">
                      <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                      <span className="text-sm">{error}</span>
                    </div>
                  )}

                  {success && (
                    <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-start gap-2 mb-4">
                      <CheckCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                      <span className="text-sm">{success}</span>
                    </div>
                  )}

                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Buscar Local o Inquilino
                      </label>
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                        <input
                          type="text"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Ej: 25, Equindeca, Ba√±os..."
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Seleccionar Local *
                      </label>
                      <select
                        value={selectedLocal}
                        onChange={(e) => setSelectedLocal(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="">-- Seleccione un local --</option>
                        {filteredLocales.map(local => {
                          const hoy = new Date().toISOString().split('T')[0];
                          const yaRegistrado = registros.find(r => 
                            String(r.local) === String(local.numero) && 
                            r.fecha.split('T')[0] === hoy
                          );
                          const etiqueta = local.grupo ? `${local.numero} (Medidor Compartido)` : local.numero;
                          return (
                            <option key={local.numero} value={local.numero} disabled={yaRegistrado}>
                              {etiqueta} - {local.inquilino} {yaRegistrado ? '‚úì' : ''}
                              {local.ultimaLectura > 0 ? ` (${local.ultimaLectura} m¬≥)` : ''}
                            </option>
                          );
                        })}
                      </select>
                      {searchTerm && filteredLocales.length === 0 && (
                        <p className="text-sm text-gray-500 mt-2">No se encontraron locales</p>
                      )}
                    </div>

                    {selectedLocal && (
                      <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                        <p className="text-sm text-yellow-800">
                          <strong>Local {selectedLocal} - {locales.find(l => String(l.numero) === String(selectedLocal))?.inquilino}</strong>
                          <br />
                          √öltima lectura: {locales.find(l => String(l.numero) === String(selectedLocal))?.ultimaLectura || 0} m¬≥
                          {locales.find(l => String(l.numero) === String(selectedLocal))?.fechaUltimaLectura && (
                            <span className="block text-xs mt-1">
                              Fecha: {new Date(locales.find(l => String(l.numero) === String(selectedLocal)).fechaUltimaLectura).toLocaleDateString()}
                            </span>
                          )}
                        </p>
                      </div>
                    )}

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Lectura del Medidor (m¬≥) *
                      </label>
                      <input
                        type="number"
                        step="0.01"
                        value={lectura}
                        onChange={(e) => setLectura(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ej: 1234.56"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Foto del Medidor (opcional)
                      </label>
                      <input
                        id="foto-input"
                        type="file"
                        accept="image/*"
                        capture="environment"
                        onChange={handleFileChange}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      {foto && (
                        <div className="mt-4">
                          <img src={foto} alt="Preview" className="w-full max-h-64 object-contain rounded-lg border border-gray-300" />
                        </div>
                      )}
                    </div>

                    <button
                      onClick={handleSubmit}
                      disabled={loading}
                      className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition-colors"
                    >
                      <Camera className="w-5 h-5" />
                      {loading ? 'Guardando...' : 'Registrar Lectura'}
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-lg font-bold text-gray-800 mb-4">Mis Registros de Hoy</h2>
                  <div className="space-y-3">
                    {registros
                      .filter(r => r.username === user.username && r.fecha.split('T')[0] === new Date().toISOString().split('T')[0])
                      .map(r => (
                        <div key={r.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium text-gray-800">{r.local} - {r.inquilino}</p>
                            <p className="text-sm text-gray-600">{r.lectura} m¬≥ - {new Date(r.fecha).toLocaleTimeString()}</p>
                          </div>
                          <CheckCircle className="w-6 h-6 text-green-500" />
                        </div>
                      ))}
                    {registros.filter(r => r.username === user.username && r.fecha.split('T')[0] === new Date().toISOString().split('T')[0]).length === 0 && (
                      <p className="text-center text-gray-500 py-4">No has registrado ning√∫n local hoy</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<MedidorApp />, document.getElementById('root'));
    </script>
</body>
</html>
</html>

