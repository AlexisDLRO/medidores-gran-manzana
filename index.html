<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Registro de Medidores de Agua - La Gran Manzana">
    <title>La Gran Manzana - Medidores</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com/3.3.0"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .logo-text {
            color: #252b5d; /* Azul de La Gran Manzana */
            font-weight: bold;
        }
        .bg-verde-lgm {
            background-color: #919677; /* Verde de La Gran Manzana */
        }
        .bg-azul-lgm {
            background-color: #252b5d; /* Azul de La Gran Manzana */
        }
        .text-verde-lgm {
            color: #919677; /* Verde de La Gran Manzana */
        }
        .text-azul-lgm {
            color: #252b5d; /* Azul de La Gran Manzana */
        }
        .border-verde-lgm {
            border-color: #919677; /* Verde de La Gran Manzana */
        }
        .border-azul-lgm {
            border-color: #252b5d; /* Azul de La Gran Manzana */
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://lecuturalgm-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        let database;
        let firebaseInitialized = false;
        try {
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseInitialized = true;
            console.log('Firebase inicializado correctamente');
        } catch (error) {
            console.error('Error inicializando Firebase:', error);
            firebaseInitialized = false;
        }

        // Iconos
        const Camera = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const LogOut = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeWidth={2} />
                <line x1="12" y1="8" x2="12" y2="12" strokeWidth={2} strokeLinecap="round" />
                <line x1="12" y1="16" x2="12.01" y2="16" strokeWidth={2} strokeLinecap="round" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Clock = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeWidth={2} />
                <polyline points="12 6 12 12 16 14" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth={2} />
                <line x1="16" y1="2" x2="16" y2="6" strokeWidth={2} strokeLinecap="round" />
                <line x1="8" y1="2" x2="8" y2="6" strokeWidth={2} strokeLinecap="round" />
                <line x1="3" y1="10" x2="21" y2="10" strokeWidth={2} />
            </svg>
        );

        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" strokeWidth={2} />
                <path d="m21 21-4.35-4.35" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const Wifi = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
            </svg>
        );

        const WifiOff = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="1" y1="1" x2="23" y2="23" strokeWidth={2} strokeLinecap="round" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16.72 11.06A10.94 10.94 0 0119 12.55M5 12.55a10.94 10.94 0 015.17-2.39M10.71 5.05A16 16 0 0122.58 9M1.42 9a15.91 15.91 0 014.7-2.88M8.53 16.11a6 6 0 016.95 0M12 20h.01" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 4 23 10 17 10" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                <polyline points="1 20 1 14 7 14" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
            </svg>
        );

        const CloudUpload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const Edit = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        );

        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const MedidorApp = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('login');
          const [locales, setLocales] = useState([]);
          const [selectedLocal, setSelectedLocal] = useState('');
          const [lectura, setLectura] = useState('');
          const [foto, setFoto] = useState(null);
          const [registros, setRegistros] = useState([]);
          const [error, setError] = useState('');
          const [success, setSuccess] = useState('');
          const [loading, setLoading] = useState(false);
          const [loginUsername, setLoginUsername] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [nombreGuardia, setNombreGuardia] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [isOnline, setIsOnline] = useState(navigator.onLine);
          const [syncStatus, setSyncStatus] = useState('');
          const [firebaseError, setFirebaseError] = useState('');
          const [editandoRegistro, setEditandoRegistro] = useState(null);
          const [editLectura, setEditLectura] = useState('');
          const [fechaInicio, setFechaInicio] = useState('');
          const [fechaFin, setFechaFin] = useState('');
          const [syncQueue, setSyncQueue] = useState([]);
          const [syncing, setSyncing] = useState(false);

          // Datos de locales - EN EL ORDEN EXACTO ESPECIFICADO
          const localesData = [
            {numero: "1-2-3-4", inquilino: "Ancla Izquierda", estado: "Vacía", grupo: true},
            {numero: 5, inquilino: "Ancla Izquierda"},
            {numero: 6, inquilino: "Elizabeth Godoy"},
            {numero: 7, inquilino: "Elizabeth Godoy"},
            {numero: 8, inquilino: "Elizabeth Godoy"},
            {numero: 9, inquilino: "Elizabeth Godoy"},
            {numero: 10, inquilino: "Ama Importadora"},
            {numero: 11, inquilino: "Temperteck"},
            {numero: "12-13", inquilino: "Elizabeth Godoy", grupo: true},
            {numero: 14, inquilino: "Cecilia Moreno"},
            {numero: 15, inquilino: "Pacific Cargo"},
            {numero: 16, inquilino: "Dassconfort"},
            {numero: 17, inquilino: "Dassconfort"},
            {numero: 18, inquilino: "Jessica Aragon"},
            {numero: 19, inquilino: "Roger Echanique"},
            {numero: 20, inquilino: "Premiuntech"},
            {numero: 21, inquilino: "Premiuntech"},
            {numero: 22, inquilino: "Premiuntech"},
            {numero: 23, inquilino: "Aviauto"},
            {numero: 24, inquilino: "Frankimport"},
            {numero: 25, inquilino: "Equindeca"},
            {numero: 26, inquilino: "MedicHome"},
            {numero: 27, inquilino: "MedicHome"},
            {numero: 28, inquilino: "Aviauto"},
            {numero: 29, inquilino: "Aviauto"},
            {numero: 30, inquilino: "Mauricio Negrete"},
            {numero: 31, inquilino: "Dulcalab"},
            {numero: 32, inquilino: "Equindeca"},
            {numero: 33, inquilino: "Equindeca"},
            {numero: 34, inquilino: "Equindeca"},            
            {numero: 35, inquilino: "She"},
            {numero: 36, inquilino: "AutoCentrum"},
            {numero: 37, inquilino: "Ignacio Baque"},
            {numero: 38, inquilino: "Surtibell"},
            {numero: 39, inquilino: "Cendecom"},
            {numero: 40, inquilino: "Camembert"},
            {numero: 41, inquilino: "Bitelnet"},
            {numero: 42, inquilino: "Kaseruc"},
            {numero: 43, inquilino: "Gilbert Global"},
            {numero: 44, inquilino: "Gilbert Global"},
            {numero: 45, inquilino: "Patsy Perez"},
            {numero: 46, inquilino: "RecorDental"},
            {numero: 47, inquilino: "Elektorres"},
            {numero: 48, inquilino: "Innovamedikal"},
            {numero: 49, inquilino: "Innovamedikal"},
            {numero: "50-51-52", inquilino: "Jorge Vera", grupo: true},
            {numero: 53, inquilino: "Patricia Celleri"},
            {numero: 54, inquilino: "Imporfrio"},
            {numero: 55, inquilino: "Proteinas & Company"},
            {numero: 56, inquilino: "Corpkadilac"},
            {numero: 57, inquilino: "Corpkadilac"},
            {numero: "58-59", inquilino: "Kissu", grupo: true},
            {numero: 60, inquilino: "Bticino"},
            {numero: 61, inquilino: "Rigotech"},
            {numero: 62, inquilino: "Samsung"},
            {numero: 63, inquilino: "VentaMark"},
            {numero: 64, inquilino: "VentaMark"},
            {numero: 65, inquilino: "Qaltrom"},
            {numero: 66, inquilino: "Qaltrom"},
            {numero: 67, inquilino: "James Brown"},
            {numero: 68, inquilino: "James Brown"},
            {numero: 69, inquilino: "Coop. 27 de Noviembre"},
            {numero: 70, inquilino: "Beatriz Roman"},
            {numero: 71, inquilino: "Kaseruc"},
            {numero: 72, inquilino: "RecorDental"},
            {numero: 73, inquilino: "Corpkadilac"},
            {numero: "74-75", inquilino: "Innovamedikal", grupo: true},
            {numero: 76, inquilino: "Yessenia Fernandez"},
            {numero: "77-78", inquilino: "Corpkadilac", grupo: true},
            {numero: 79, inquilino: "Corpkadilac"},
            {numero: "80-81-82-83-84", inquilino: "Consorcio Gane", grupo: true},
            {numero: "85-86-87", inquilino: "Elvis Crespo", grupo: true},
            {numero: 88, inquilino: "Enterprise Motors"},
            {numero: 89, inquilino: "Enterprise Motors"},
            {numero: 90, inquilino: "Enterprise Motors"},
            {numero: 91, inquilino: "Karina Nazareno"},
            {numero: 92, inquilino: "Rapsecon"},
            {numero: 93, inquilino: "Rapsecon"},
            {numero: 94, inquilino: "FootCell"},
            {numero: "95-96-97", inquilino: "Sesinaqua", grupo: true},
            {numero: 98, inquilino: "Innovamedikal"},
            {numero: 99, inquilino: "ServiCar"},
            {numero: "100-101", inquilino: "Kissu", grupo: true},
            {numero: 102, inquilino: "Vacío"},
            {numero: 103, inquilino: "TKVElectros"},
            {numero: 104, inquilino: "Schullo"},
            {numero: 105, inquilino: "Schullo"},
            {numero: 106, inquilino: "Barbara Adum"},
            {numero: 107, inquilino: "Envios Rapidos"},
            {numero: 108, inquilino: "Kaseruc"},
            {numero: 109, inquilino: "Camembert"},
            {numero: 110, inquilino: "Camembert"},
            {numero: 111, inquilino: "Andrea Naula"},
            {numero: 112, inquilino: "Norvida"},
            {numero: 113, inquilino: "Norvida"},
            {numero: 114, inquilino: "Norvida"},
            {numero: "115-116", inquilino: "Norvida", grupo: true},
            {numero: 117, inquilino: "Norvida"},
            {numero: 118, inquilino: "Norvida"},
            {numero: 119, inquilino: "Norvida"},
            {numero: 120, inquilino: "Norvida"},
            {numero: 121, inquilino: "Norvida"},
            {numero: 122, inquilino: "Norvida"},
            {numero: 123, inquilino: "Camembert"},
            {numero: 124, inquilino: "Ricardo Cedeño"},
            {numero: 125, inquilino: "Jami"},
            {numero: 126, inquilino: "Sinpetsa"},
            {numero: 127, inquilino: "Vacío"},
            {numero: 128, inquilino: "Vacío"},
            {numero: 129, inquilino: "Rayos X"},
            {numero: 130, inquilino: "Distrimass"},
            {numero: 131, inquilino: "Pharmatotal"},
            {numero: 132, inquilino: "Pharmatotal"},
            {numero: 133, inquilino: "K'archer"},
            {numero: "R-CG", inquilino: "Riego Consorcio Gane"},
            {numero: "R-BM", inquilino: "Riego Banco de Miro"},
            {numero: "B-PUB", inquilino: "Baños Publicos"},
            {numero: "B-EMP", inquilino: "Baños de empleados"},
            {numero: "B-GAN", inquilino: "Baños Gane"},
            {numero: "ML-L6", inquilino: "Medidor Limpieza (L6)"},
            {numero: "ML-L15", inquilino: "Medidor Limpieza (L15)"},
            {numero: "ML-L24", inquilino: "Medidor Limpieza (L24)"},
            {numero: "ML-L41", inquilino: "Medidor Limpieza (L41)"},
            {numero: "ML-L60", inquilino: "Medidor Limpieza (L60)"},
            {numero: "ML-L68", inquilino: "Medidor Limpieza (L68)"},
            {numero: "ML-L79", inquilino: "Medidor Limpieza (L79)"},
            {numero: "ML-L87", inquilino: "Medidor Limpieza (L87)"},
            {numero: "ML-L102", inquilino: "Medidor Limpieza (L102)"},
            {numero: "ML-L108", inquilino: "Medidor Limpieza (L108)"},
            {numero: "ML-L123", inquilino: "Medidor Limpieza (L123)"},
            {numero: "M-OFI", inquilino: "Contenedor 1 atrás Oficina"},
            {numero: "M-L49", inquilino: "Contenedor 2 atrás L49"},
            {numero: "M-BOM", inquilino: "Cuarto de Bombas"},
            {numero: "M-GEN", inquilino: "Medidor General"},
            {numero: "MAD-001", inquilino: "Medidor Adicional 001"},
            {numero: "MAD-002", inquilino: "Medidor Adicional 002"},
            {numero: "MAD-003", inquilino: "Medidor Adicional 003"}
          ];

          // Función para obtener la fecha local en formato YYYY-MM-DD
          const obtenerFechaLocal = (fechaISO) => {
            if (!fechaISO) return '';
            const fecha = new Date(fechaISO);
            // Ajustar por la zona horaria local
            const offset = fecha.getTimezoneOffset() * 60000; // offset en milisegundos
            const fechaLocal = new Date(fecha.getTime() - offset);
            return fechaLocal.toISOString().split('T')[0];
          };

          // Función para obtener la fecha de hoy en formato YYYY-MM-DD (local)
          const obtenerHoy = () => {
            const hoy = new Date();
            return obtenerFechaLocal(hoy.toISOString());
          };

          // FUNCIONES DE ORDENAMIENTO MODIFICADAS - Mantienen el orden exacto de localesData
          const ordenarLocales = (a, b) => {
            // Mantener el orden original del array localesData
            const indexA = localesData.findIndex(local => String(local.numero) === String(a.numero));
            const indexB = localesData.findIndex(local => String(local.numero) === String(b.numero));
            
            return indexA - indexB;
          };

          const ordenarRegistros = (a, b) => {
            const indexA = localesData.findIndex(local => String(local.numero) === String(a.local));
            const indexB = localesData.findIndex(local => String(local.numero) === String(b.local));
            
            return indexA - indexB;
          };

          // FUNCIONES PARA SINCRONIZACIÓN OFFLINE
          const guardarRegistroLocal = (registro) => {
            try {
              const registrosLocales = JSON.parse(localStorage.getItem('registros-offline-gran-manzana') || '[]');
              registrosLocales.push(registro);
              localStorage.setItem('registros-offline-gran-manzana', JSON.stringify(registrosLocales));
              return true;
            } catch (error) {
              console.error('Error guardando registro local:', error);
              return false;
            }
          };

          const cargarRegistrosLocales = () => {
            try {
              const registrosLocales = JSON.parse(localStorage.getItem('registros-offline-gran-manzana') || '[]');
              return registrosLocales;
            } catch (error) {
              console.error('Error cargando registros locales:', error);
              return [];
            }
          };

          const eliminarRegistroLocal = (id) => {
            try {
              const registrosLocales = JSON.parse(localStorage.getItem('registros-offline-gran-manzana') || '[]');
              const nuevosRegistros = registrosLocales.filter(r => r.id !== id);
              localStorage.setItem('registros-offline-gran-manzana', JSON.stringify(nuevosRegistros));
              return true;
            } catch (error) {
              console.error('Error eliminando registro local:', error);
              return false;
            }
          };

          const sincronizarRegistrosOffline = async () => {
            if (!firebaseInitialized || !database || !isOnline) {
              return false;
            }

            setSyncing(true);
            setSyncStatus('Sincronizando registros offline...');

            try {
              const registrosLocales = cargarRegistrosLocales();
              let sincronizados = 0;
              let errores = 0;

              for (const registro of registrosLocales) {
                try {
                  await guardarRegistroFirebase(registro);
                  eliminarRegistroLocal(registro.id);
                  sincronizados++;
                } catch (error) {
                  console.error('Error sincronizando registro:', error);
                  errores++;
                }
              }

              setSyncStatus(`Sincronización completada: ${sincronizados} registros sincronizados, ${errores} errores`);
              setTimeout(() => setSyncStatus(''), 5000);

              // Recargar los registros desde Firebase
              if (sincronizados > 0) {
                cargarRegistrosFirebase();
              }

              setSyncing(false);
              return true;
            } catch (error) {
              console.error('Error en sincronización:', error);
              setSyncStatus('Error en sincronización');
              setTimeout(() => setSyncStatus(''), 5000);
              setSyncing(false);
              return false;
            }
          };

          const cargarRegistrosFirebase = () => {
            if (!firebaseInitialized || !database) return;

            try {
              const registrosRef = database.ref('registros');
              registrosRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                  const registrosArray = Object.keys(data).map(key => ({
                    firebaseId: key,
                    ...data[key]
                  }));
                  setRegistros(registrosArray.sort(ordenarRegistros));
                }
              });
            } catch (error) {
              console.error('Error cargando registros de Firebase:', error);
            }
          };

          useEffect(() => {
            loadData();
            if (firebaseInitialized) {
              setupFirebaseListeners();
            }
            
            const handleOnline = () => {
              setIsOnline(true);
              setSyncStatus('Conectado a Firebase - Sincronizando...');
              // Sincronizar registros offline cuando se recupera la conexión
              setTimeout(() => {
                sincronizarRegistrosOffline();
              }, 2000);
            };
            
            const handleOffline = () => {
              setIsOnline(false);
              setSyncStatus('Modo offline - Los datos se guardarán localmente');
              setTimeout(() => setSyncStatus(''), 5000);
            };
            
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
            };
          }, []);

          const setupFirebaseListeners = () => {
            if (!firebaseInitialized || !database) {
              setFirebaseError('Firebase no está inicializado');
              return;
            }

            try {
              const registrosRef = database.ref('registros');
              registrosRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                  const registrosArray = Object.keys(data).map(key => ({
                    firebaseId: key,
                    ...data[key]
                  }));
                  setRegistros(registrosArray.sort(ordenarRegistros));
                  setFirebaseError('');
                } else {
                  setRegistros([]);
                }
              }, (error) => {
                console.error('Error escuchando registros:', error);
                setFirebaseError('Error conectando a Firebase: ' + error.message);
              });

            } catch (error) {
              console.error('Error configurando listeners:', error);
              setFirebaseError('Error de conexión con Firebase');
            }
          };

          const loadData = () => {
            try {
              // SIN .sort() - Mantiene el orden original de localesData
              const initialLocales = localesData.map(l => ({
                ...l,
                ultimaLectura: 0,
                fechaUltimaLectura: null
              }));

              const localesStorage = localStorage.getItem('locales-gran-manzana');
              if (localesStorage) {
                const savedLocales = JSON.parse(localesStorage);
                savedLocales.forEach(saved => {
                  const local = initialLocales.find(l => String(l.numero) === String(saved.numero));
                  if (local && saved.ultimaLectura) {
                    local.ultimaLectura = saved.ultimaLectura;
                    local.fechaUltimaLectura = saved.fechaUltimaLectura;
                  }
                });
              }

              setLocales(initialLocales);

              // Cargar registros locales offline
              const registrosLocales = cargarRegistrosLocales();
              if (registrosLocales.length > 0) {
                setRegistros(prev => [...prev, ...registrosLocales].sort(ordenarRegistros));
              }

            } catch (err) {
              console.error('Error cargando datos:', err);
              // SIN .sort() - Mantiene el orden original de localesData
              setLocales(localesData.map(l => ({
                ...l,
                ultimaLectura: 0,
                fechaUltimaLectura: null
              })));
            }
          };

          const guardarRegistroFirebase = async (registro) => {
            if (!firebaseInitialized || !database) {
              throw new Error('Firebase no está disponible');
            }

            try {
              const registroRef = database.ref('registros').push();
              await registroRef.set(registro);
              return true;
            } catch (error) {
              console.error('Error guardando en Firebase:', error);
              throw error;
            }
          };

          const actualizarRegistroFirebase = async (firebaseId, nuevosDatos) => {
            if (!firebaseInitialized || !database) {
              throw new Error('Firebase no está disponible');
            }

            try {
              await database.ref(`registros/${firebaseId}`).update(nuevosDatos);
              return true;
            } catch (error) {
              console.error('Error actualizando en Firebase:', error);
              throw error;
            }
          };

          const eliminarRegistroFirebase = async (firebaseId) => {
            if (!firebaseInitialized || !database) {
              throw new Error('Firebase no está disponible');
            }

            try {
              await database.ref(`registros/${firebaseId}`).remove();
              return true;
            } catch (error) {
              console.error('Error eliminando en Firebase:', error);
              throw error;
            }
          };

          const handleLogin = () => {
            const usuarios = {
              'guardia': { password: '1234', rol: 'guardia' },
              'admin': { password: 'admin123', nombre: 'Administrador', rol: 'admin' }
            };

            if (loginUsername === 'guardia') {
              if (usuarios[loginUsername].password === loginPassword) {
                if (!nombreGuardia.trim()) {
                  setError('Por favor ingrese su nombre completo');
                  return;
                }
                setUser({ username: loginUsername, nombre: nombreGuardia.trim(), rol: 'guardia' });
                setView('registro');
                setError('');
                setLoginUsername('');
                setLoginPassword('');
                setNombreGuardia('');
              } else {
                setError('Contraseña incorrecta');
              }
            } else if (usuarios[loginUsername] && usuarios[loginUsername].password === loginPassword) {
              setUser({ username: loginUsername, ...usuarios[loginUsername] });
              setView(usuarios[loginUsername].rol === 'admin' ? 'admin' : 'registro');
              setError('');
              setLoginUsername('');
              setLoginPassword('');
            } else {
              setError('Usuario o contraseña incorrectos');
            }
          };

          const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
              if (file.size > 5000000) {
                setError('La foto es muy grande. Máximo 5MB');
                return;
              }
              const reader = new FileReader();
              reader.onloadend = () => {
                setFoto(reader.result);
                setError('');
              };
              reader.readAsDataURL(file);
            }
          };

          const validarLectura = (lecturaValidar, localValidar) => {
            const local = locales.find(l => String(l.numero) === String(localValidar));
            const lecturaNum = parseFloat(lecturaValidar);

            if (!localValidar) return 'Debe seleccionar un local';
            if (!lecturaValidar || isNaN(lecturaNum)) return 'Debe ingresar una lectura válida';
            if (local.ultimaLectura && lecturaNum < local.ultimaLectura) {
              return `La lectura no puede ser menor a la anterior (${local.ultimaLectura})`;
            }
            if (local.ultimaLectura && lecturaNum > local.ultimaLectura + 1000) {
              return `La lectura parece muy alta. Anterior: ${local.ultimaLectura}, Nueva: ${lecturaNum}. ¿Está seguro?`;
            }

            const hoy = obtenerHoy();
            const yaRegistrado = registros.find(r => {
              if (!r.fecha) return false;
              const fechaRegistro = obtenerFechaLocal(r.fecha);
              return String(r.local) === String(localValidar) && 
                     fechaRegistro === hoy &&
                     (!editandoRegistro || r.firebaseId !== editandoRegistro.firebaseId);
            });
            if (yaRegistrado) return 'Este local ya fue registrado hoy';

            return null;
          };

          const handleSubmit = async () => {
            setLoading(true);
            setError('');
            setSuccess('');

            const errorValidacion = validarLectura(lectura, selectedLocal);
            if (errorValidacion) {
              setError(errorValidacion);
              setLoading(false);
              return;
            }

            try {
              const ahora = new Date().toISOString();
              const lecturaNum = parseFloat(lectura);
              const localData = locales.find(l => String(l.numero) === String(selectedLocal));

              const nuevoRegistro = {
                id: Date.now(), // ID local único
                local: selectedLocal,
                inquilino: localData.inquilino,
                lectura: lecturaNum,
                foto: foto,
                fecha: ahora,
                guardia: user.nombre,
                username: user.username
              };

              let guardado = false;
              
              if (firebaseInitialized && database && isOnline) {
                try {
                  guardado = await guardarRegistroFirebase(nuevoRegistro);
                  if (guardado) {
                    setSuccess(`✓ Local ${selectedLocal} - ${localData.inquilino} registrado correctamente`);
                  }
                } catch (firebaseError) {
                  console.warn('Error con Firebase, guardando localmente:', firebaseError);
                  // Si falla Firebase, guardar localmente
                  guardado = guardarRegistroLocal(nuevoRegistro);
                  if (guardado) {
                    setSuccess(`✓ Local ${selectedLocal} - ${localData.inquilino} guardado localmente (sin conexión)`);
                  }
                }
              } else {
                // Modo offline - guardar localmente
                guardado = guardarRegistroLocal(nuevoRegistro);
                if (guardado) {
                  setSuccess(`✓ Local ${selectedLocal} - ${localData.inquilino} guardado localmente (modo offline)`);
                }
              }
              
              if (!guardado) {
                setError('Error al guardar el registro');
                setLoading(false);
                return;
              }

              // Actualizar el estado local en cualquier caso
              const localesActualizados = locales.map(l => 
                String(l.numero) === String(selectedLocal)
                  ? { ...l, ultimaLectura: lecturaNum, fechaUltimaLectura: ahora }
                  : l
              );
              
              localStorage.setItem('locales-gran-manzana', JSON.stringify(localesActualizados));
              setLocales(localesActualizados);

              // Agregar a registros locales para mostrar inmediatamente
              setRegistros(prev => [...prev, nuevoRegistro].sort(ordenarRegistros));

              setSelectedLocal('');
              setLectura('');
              setFoto(null);
              setSearchTerm('');
              
              const fileInput = document.getElementById('foto-input');
              if (fileInput) fileInput.value = '';

            } catch (err) {
              setError('Error al guardar el registro: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const iniciarEdicion = (registro) => {
            setEditandoRegistro(registro);
            setEditLectura(registro.lectura);
          };

          const cancelarEdicion = () => {
            setEditandoRegistro(null);
            setEditLectura('');
          };

          const guardarEdicion = async () => {
            if (!editandoRegistro) return;

            setLoading(true);
            setError('');
            setSuccess('');

            const errorValidacion = validarLectura(editLectura, editandoRegistro.local);
            if (errorValidacion) {
              setError(errorValidacion);
              setLoading(false);
              return;
            }

            try {
              const lecturaNum = parseFloat(editLectura);
              const registroActualizado = {
                ...editandoRegistro,
                lectura: lecturaNum,
                fecha: new Date().toISOString()
              };

              let actualizado = false;

              if (firebaseInitialized && database && isOnline && editandoRegistro.firebaseId) {
                try {
                  actualizado = await actualizarRegistroFirebase(editandoRegistro.firebaseId, {
                    lectura: lecturaNum,
                    fecha: registroActualizado.fecha
                  });
                } catch (firebaseError) {
                  console.warn('Error actualizando en Firebase:', firebaseError);
                  // Si es un registro offline, actualizar localmente
                  if (editandoRegistro.id) {
                    const registrosLocales = cargarRegistrosLocales();
                    const nuevosRegistros = registrosLocales.map(r => 
                      r.id === editandoRegistro.id ? registroActualizado : r
                    );
                    localStorage.setItem('registros-offline-gran-manzana', JSON.stringify(nuevosRegistros));
                    actualizado = true;
                  }
                }
              } else if (editandoRegistro.id) {
                // Actualizar registro offline
                const registrosLocales = cargarRegistrosLocales();
                const nuevosRegistros = registrosLocales.map(r => 
                  r.id === editandoRegistro.id ? registroActualizado : r
                );
                localStorage.setItem('registros-offline-gran-manzana', JSON.stringify(nuevosRegistros));
                actualizado = true;
              }

              if (actualizado) {
                setRegistros(prev => prev.map(r => 
                  (r.firebaseId === editandoRegistro.firebaseId || r.id === editandoRegistro.id) 
                    ? registroActualizado 
                    : r
                ));

                const localesActualizados = locales.map(l => 
                  String(l.numero) === String(editandoRegistro.local)
                    ? { ...l, ultimaLectura: lecturaNum, fechaUltimaLectura: registroActualizado.fecha }
                    : l
                );
                
                localStorage.setItem('locales-gran-manzana', JSON.stringify(localesActualizados));
                setLocales(localesActualizados);

                setSuccess(`✓ Lectura del local ${editandoRegistro.local} actualizada correctamente`);
                cancelarEdicion();
              } else {
                setError('Error al actualizar el registro');
              }

            } catch (err) {
              setError('Error al actualizar el registro: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const eliminarRegistro = async (registro) => {
            if (!confirm('¿Está seguro de que desea eliminar este registro?')) {
              return;
            }

            setLoading(true);
            setError('');
            setSuccess('');

            try {
              let eliminado = false;

              if (firebaseInitialized && database && isOnline && registro.firebaseId) {
                try {
                  eliminado = await eliminarRegistroFirebase(registro.firebaseId);
                } catch (firebaseError) {
                  console.warn('Error eliminando en Firebase:', firebaseError);
                  // Si es un registro offline, eliminar localmente
                  if (registro.id) {
                    eliminado = eliminarRegistroLocal(registro.id);
                  }
                }
              } else if (registro.id) {
                // Eliminar registro offline
                eliminado = eliminarRegistroLocal(registro.id);
              }

              if (eliminado) {
                setRegistros(prev => prev.filter(r => 
                  r.firebaseId !== registro.firebaseId && r.id !== registro.id
                ));
                setSuccess(`✓ Registro del local ${registro.local} eliminado correctamente`);
              } else {
                setError('Error al eliminar el registro');
              }

            } catch (err) {
              setError('Error al eliminar el registro: ' + err.message);
            } finally {
              setLoading(false);
            }
          };

          const exportarExcel = () => {
            const hoy = obtenerHoy();
            const registrosHoy = registros.filter(r => {
              if (!r.fecha) return false;
              const fechaRegistro = obtenerFechaLocal(r.fecha);
              return fechaRegistro === hoy;
            });
            
            let csv = 'Fecha;Hora;Local;Inquilino;Lectura (m³);Guardia;Tiene Foto\n';
            
            // Ordenar registros para el Excel
            const registrosOrdenados = [...registrosHoy].sort(ordenarRegistros);
            
            registrosOrdenados.forEach(r => {
              const fecha = r.fecha ? new Date(r.fecha) : new Date();
              const fechaStr = fecha.toLocaleDateString('es-EC');
              const horaStr = fecha.toLocaleTimeString('es-EC');
              const tieneFoto = r.foto ? 'Sí' : 'No';
              
              // FORMATO CORREGIDO: Reemplazar punto por coma para decimales
              // y formatear números grandes sin separadores de miles
              let lecturaFormateada;
              if (r.lectura !== undefined && r.lectura !== null) {
                // Convertir a número y formatear con comas para decimales
                const numero = parseFloat(r.lectura);
                // Usar 3 decimales como máximo
                lecturaFormateada = numero.toLocaleString('es-ES', {
                  minimumFractionDigits: 1,
                  maximumFractionDigits: 3,
                  useGrouping: false // Sin separadores de miles
                });
              } else {
                lecturaFormateada = '0';
              }
              
              const limpiar = (texto) => {
                texto = String(texto).replace(/;/g, ',');
                return texto;
              };
              
              csv += `${fechaStr};${horaStr};${limpiar(r.local)};${limpiar(r.inquilino)};${lecturaFormateada};${limpiar(r.guardia)};${tieneFoto}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lecturas-gran-manzana-${hoy}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          };

          // FUNCIÓN PARA EXPORTAR POR FECHAS
          const exportarExcelPorFechas = () => {
            if (!fechaInicio) {
              setError('Por favor seleccione una fecha de inicio');
              return;
            }

            // Si no se selecciona fecha fin, usar la misma fecha de inicio
            const fechaFinSeleccionada = fechaFin || fechaInicio;
            
            const registrosFiltrados = registros.filter(r => {
              if (!r.fecha) return false;
              const fechaRegistro = obtenerFechaLocal(r.fecha);
              return fechaRegistro >= fechaInicio && fechaRegistro <= fechaFinSeleccionada;
            });

            if (registrosFiltrados.length === 0) {
              setError('No hay registros para el rango de fechas seleccionado');
              return;
            }

            let csv = 'Fecha;Hora;Local;Inquilino;Lectura (m³);Guardia;Tiene Foto\n';
            
            // Ordenar registros para el Excel
            const registrosOrdenados = [...registrosFiltrados].sort(ordenarRegistros);
            
            registrosOrdenados.forEach(r => {
              const fecha = r.fecha ? new Date(r.fecha) : new Date();
              const fechaStr = fecha.toLocaleDateString('es-EC');
              const horaStr = fecha.toLocaleTimeString('es-EC');
              const tieneFoto = r.foto ? 'Sí' : 'No';
              
              // FORMATO CORREGIDO: Reemplazar punto por coma para decimales
              // y formatear números grandes sin separadores de miles
              let lecturaFormateada;
              if (r.lectura !== undefined && r.lectura !== null) {
                // Convertir a número y formatear con comas para decimales
                const numero = parseFloat(r.lectura);
                // Usar 3 decimales como máximo
                lecturaFormateada = numero.toLocaleString('es-ES', {
                  minimumFractionDigits: 1,
                  maximumFractionDigits: 3,
                  useGrouping: false // Sin separadores de miles
                });
              } else {
                lecturaFormateada = '0';
              }
              
              const limpiar = (texto) => {
                texto = String(texto).replace(/;/g, ',');
                return texto;
              };
              
              csv += `${fechaStr};${horaStr};${limpiar(r.local)};${limpiar(r.inquilino)};${lecturaFormateada};${limpiar(r.guardia)};${tieneFoto}\n`;
            });

            const nombreArchivo = fechaInicio === fechaFinSeleccionada 
              ? `lecturas-gran-manzana-${fechaInicio}.csv`
              : `lecturas-gran-manzana-${fechaInicio}-a-${fechaFinSeleccionada}.csv`;

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            setSuccess(`Excel exportado correctamente: ${registrosFiltrados.length} registros`);
          };

          const calcularProgreso = () => {
            const hoy = obtenerHoy();
            const registrosHoy = registros.filter(r => {
              if (!r.fecha) return false;
              const fechaRegistro = obtenerFechaLocal(r.fecha);
              return fechaRegistro === hoy;
            });
            return {
              completados: registrosHoy.length,
              total: locales.length,
              porcentaje: locales.length > 0 ? Math.round((registrosHoy.length / locales.length) * 100) : 0
            };
          };

          // SIN .sort() - Mantiene el orden original de localesData
          const filteredLocales = locales.filter(local => {
            const search = searchTerm.toLowerCase();
            return (
              String(local.numero).toLowerCase().includes(search) ||
              local.inquilino.toLowerCase().includes(search)
            );
          });

          if (!user) {
            return (
              <div className="min-h-screen bg-azul-lgm flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-gray-200">
                  <div className="text-center mb-8">
                    <div className="mb-4">
                      <h1 className="text-4xl font-bold text-azul-lgm mb-2">La Gran Manzana</h1>
                      <div className="text-sm text-gray-600 space-y-1">
                        <p className="font-semibold">Centro Comercial</p>
                        <p>Sistema de Registro de Medidores</p>
                      </div>
                    </div>
                    <div className="mt-3 flex items-center justify-center gap-2">
                      {isOnline ? (
                        <span className="flex items-center gap-1 text-green-600 text-sm">
                          <Wifi className="w-4 h-4" />
                          {firebaseInitialized ? 'Conectado a Firebase' : 'Conectado (Modo Local)'}
                        </span>
                      ) : (
                        <span className="flex items-center gap-1 text-orange-600 text-sm">
                          <WifiOff className="w-4 h-4" />
                          Sin conexión
                        </span>
                      )}
                    </div>
                    {firebaseError && (
                      <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                        {firebaseError}
                      </div>
                    )}
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                      <input
                        type="text"
                        value={loginUsername}
                        onChange={(e) => setLoginUsername(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                        placeholder="Ingrese su usuario"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                      <input
                        type="password"
                        value={loginPassword}
                        onChange={(e) => setLoginPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                        placeholder="Ingrese su contraseña"
                      />
                    </div>

                    {loginUsername === 'guardia' && (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Nombre y Apellido *</label>
                        <input
                          type="text"
                          value={nombreGuardia}
                          onChange={(e) => setNombreGuardia(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                          className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                          placeholder="Ej: Juan Pérez"
                        />
                      </div>
                    )}

                    {error && (
                      <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl flex items-start gap-2">
                        <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                        <span className="text-sm">{error}</span>
                      </div>
                    )}

                    <button
                      onClick={handleLogin}
                      className="w-full bg-verde-lgm hover:bg-[#7a8560] text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                    >
                      Iniciar Sesión
                    </button>
                  </div>

                  <div className="mt-6 p-4 bg-gray-50 rounded-xl text-sm text-gray-600">
                    <p className="font-semibold mb-2">Credenciales de acceso:</p>
                    <p><strong>Guardias:</strong> usuario: guardia | contraseña: 1234</p>
                    <p className="text-xs text-gray-500 mt-1">* Después de ingresar usuario y contraseña, escriba su nombre completo</p>
                    
                  </div>

                  {!firebaseInitialized && (
                    <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-xs text-yellow-800">
                      <p className="font-semibold mb-1">⚠️ Modo Local Activado</p>
                      <p>Firebase no está disponible. Los datos se guardarán localmente.</p>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          if (view === 'admin') {
            const progreso = calcularProgreso();
            const hoy = obtenerHoy();
            const registrosHoy = registros.filter(r => {
              if (!r.fecha) return false;
              const fechaRegistro = obtenerFechaLocal(r.fecha);
              return fechaRegistro === hoy;
            });

            return (
              <div className="min-h-screen bg-gray-50 p-4">
                <div className="max-w-7xl mx-auto">
                  <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-200">
                    <div className="flex justify-between items-center mb-6">
                      <div>
                        <h1 className="text-3xl font-bold text-azul-lgm mb-2">Panel Administrativo</h1>
                        <p className="text-gray-600">Bienvenido, <span className="font-semibold text-verde-lgm">{user.nombre}</span></p>
                      </div>
                      <div className="flex items-center gap-3">
                        {isOnline ? (
                          <span className="flex items-center gap-1 text-green-600 text-sm bg-green-50 px-3 py-1 rounded-full">
                            <Wifi className="w-4 h-4" />
                            {firebaseInitialized ? 'Firebase' : 'Local'}
                          </span>
                        ) : (
                          <span className="flex items-center gap-1 text-orange-600 text-sm bg-orange-50 px-3 py-1 rounded-full">
                            <WifiOff className="w-4 h-4" />
                            Offline
                          </span>
                        )}
                        <button
                          onClick={() => { setUser(null); setView('login'); }}
                          className="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-all transform hover:scale-105"
                        >
                          <LogOut className="w-4 h-4" />
                          Salir
                        </button>
                      </div>
                    </div>

                    {syncStatus && (
                      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-800">
                        {syncStatus}
                      </div>
                    )}

                    {firebaseError && (
                      <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800">
                        {firebaseError}
                      </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div className="bg-azul-lgm text-white p-4 rounded-xl shadow-lg">
                        <div className="flex items-center gap-3">
                          <Calendar className="w-8 h-8 text-white" />
                          <div>
                            <p className="text-sm opacity-90">Fecha</p>
                            <p className="text-xl font-bold">{new Date().toLocaleDateString()}</p>
                          </div>
                        </div>
                      </div>

                      <div className="bg-verde-lgm text-white p-4 rounded-xl shadow-lg">
                        <div className="flex items-center gap-3">
                          <CheckCircle className="w-8 h-8 text-white" />
                          <div>
                            <p className="text-sm opacity-90">Registrados Hoy</p>
                            <p className="text-xl font-bold">{progreso.completados} / {progreso.total}</p>
                          </div>
                        </div>
                      </div>

                      <div className="bg-azul-lgm text-white p-4 rounded-xl shadow-lg">
                        <div className="flex items-center gap-3">
                          <Clock className="w-8 h-8 text-white" />
                          <div>
                            <p className="text-sm opacity-90">Progreso</p>
                            <p className="text-xl font-bold">{progreso.porcentaje}%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="mb-6">
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div
                          className="bg-verde-lgm h-4 rounded-full transition-all duration-500 shadow-lg"
                          style={{ width: `${progreso.porcentaje}%` }}
                        ></div>
                      </div>
                    </div>

                    {/* BOTÓN DE SINCRONIZACIÓN MANUAL */}
                    {!isOnline && (
                      <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="font-semibold text-yellow-800">Modo Offline</p>
                            <p className="text-sm text-yellow-700">Los registros se guardan localmente</p>
                          </div>
                          <button
                            onClick={sincronizarRegistrosOffline}
                            disabled={syncing || !isOnline}
                            className="flex items-center gap-2 px-4 py-2 bg-azul-lgm hover:bg-[#1a1f45] disabled:bg-gray-400 text-white rounded-xl transition-all"
                          >
                            <CloudUpload className="w-4 h-4" />
                            {syncing ? 'Sincronizando...' : 'Sincronizar'}
                          </button>
                        </div>
                      </div>
                    )}

                    {/* SECCIÓN PARA EXPORTAR POR FECHAS */}
                    <div className="bg-blue-50 p-6 rounded-xl mb-6 border border-blue-200">
                      <h3 className="text-xl font-bold text-azul-lgm mb-4 flex items-center gap-2">
                        <Calendar className="w-6 h-6" />
                        Exportar Registros por Fechas
                      </h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Fecha de Inicio *
                          </label>
                          <input
                            type="date"
                            value={fechaInicio}
                            onChange={(e) => setFechaInicio(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Fecha de Fin (opcional)
                          </label>
                          <input
                            type="date"
                            value={fechaFin}
                            onChange={(e) => setFechaFin(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                          />
                          <p className="text-xs text-gray-500 mt-1">
                            Si no selecciona fecha fin, se exportará solo la fecha de inicio
                          </p>
                        </div>
                        
                        <div className="flex items-end">
                          <button
                            onClick={exportarExcelPorFechas}
                            disabled={!fechaInicio}
                            className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-azul-lgm hover:bg-[#1a1f45] disabled:bg-gray-400 text-white rounded-xl transition-all transform hover:scale-105 font-semibold shadow-lg"
                          >
                            <Download className="w-5 h-5" />
                            Exportar por Fechas
                          </button>
                        </div>
                      </div>
                      
                      <div className="text-sm text-gray-600">
                        <p><strong>Nota:</strong> El archivo se descargará en formato CSV compatible con Excel.</p>
                        <p>Incluye todos los registros del rango de fechas seleccionado.</p>
                      </div>
                    </div>

                    <div className="flex gap-4">
                      <button
                        onClick={exportarExcel}
                        disabled={registrosHoy.length === 0}
                        className="flex items-center gap-2 px-6 py-3 bg-verde-lgm hover:bg-[#7a8560] disabled:bg-gray-400 text-white rounded-xl transition-all transform hover:scale-105 font-semibold shadow-lg"
                      >
                        <Download className="w-5 h-5" />
                        Exportar Hoy ({registrosHoy.length} registros)
                      </button>
                    </div>
                    
                    {registrosHoy.length > 0 && (
                      <p className="text-sm text-gray-600 mt-2">
                        El archivo se descargará con todas las columnas organizadas para abrir en Excel.
                      </p>
                    )}
                  </div>

                  <div className="bg-white rounded-2xl shadow-xl p-6 border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">
                      Registros de Hoy 
                      <span className="text-sm font-normal text-gray-600 ml-2">
                        {firebaseInitialized ? '(Tiempo Real)' : '(Modo Local)'}
                      </span>
                    </h2>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Local</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Inquilino</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Lectura</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Hora</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Guardia</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Foto</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Acciones</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {registrosHoy.length === 0 ? (
                            <tr>
                              <td colSpan="8" className="px-4 py-8 text-center text-gray-500">
                                No hay registros para hoy
                              </td>
                            </tr>
                          ) : (
                            registrosHoy
                              .sort(ordenarRegistros) // Ordenar registros en la tabla
                              .map(r => (
                                <tr key={r.firebaseId || r.id} className="hover:bg-gray-50 transition-colors">
                                  <td className="px-4 py-3 text-sm font-medium text-gray-900">{r.local}</td>
                                  <td className="px-4 py-3 text-sm text-gray-700">{r.inquilino}</td>
                                  <td className="px-4 py-3 text-sm text-gray-700 font-semibold">{r.lectura} m³</td>
                                  <td className="px-4 py-3 text-sm text-gray-700">
                                    {r.fecha ? new Date(r.fecha).toLocaleTimeString() : 'Hora no disponible'}
                                  </td>
                                  <td className="px-4 py-3 text-sm text-gray-700">{r.guardia}</td>
                                  <td className="px-4 py-3">
                                    {r.foto ? (
                                      <img src={r.foto} alt="Medidor" className="w-16 h-16 object-cover rounded-lg cursor-pointer shadow-sm" 
                                           onClick={() => window.open(r.foto, '_blank')} />
                                    ) : (
                                      <span className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">Sin foto</span>
                                    )}
                                  </td>
                                  <td className="px-4 py-3">
                                    {r.firebaseId ? (
                                      <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                        <Wifi className="w-3 h-3" />
                                        En Firebase
                                      </span>
                                    ) : (
                                      <span className="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
                                        <WifiOff className="w-3 h-3" />
                                        Local
                                      </span>
                                    )}
                                  </td>
                                  <td className="px-4 py-3">
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => iniciarEdicion(r)}
                                        className="flex items-center gap-1 px-3 py-1 bg-azul-lgm hover:bg-[#1a1f45] text-white rounded-lg text-xs transition-colors"
                                      >
                                        <Edit className="w-3 h-3" />
                                        Editar
                                      </button>
                                      <button
                                        onClick={() => eliminarRegistro(r)}
                                        className="flex items-center gap-1 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors"
                                      >
                                        <Trash className="w-3 h-3" />
                                        Eliminar
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                {/* Modal de Edición */}
                {editandoRegistro && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-200">
                      <h3 className="text-xl font-bold text-gray-800 mb-4">Editar Lectura</h3>
                      <div className="space-y-4">
                        <div>
                          <p className="text-sm text-gray-600 mb-2">Local: <span className="font-semibold">{editandoRegistro.local}</span></p>
                          <p className="text-sm text-gray-600 mb-4">Inquilino: <span className="font-semibold">{editandoRegistro.inquilino}</span></p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Nueva Lectura (m³) *
                          </label>
                          <input
                            type="number"
                            step="0.01"
                            value={editLectura}
                            onChange={(e) => setEditLectura(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                            placeholder="Ej: 1234.56"
                          />
                        </div>
                        <div className="flex gap-4 pt-4">
                          <button
                            onClick={guardarEdicion}
                            disabled={loading}
                            className="flex-1 bg-verde-lgm hover:bg-[#7a8560] disabled:bg-gray-400 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105"
                          >
                            {loading ? 'Guardando...' : 'Guardar Cambios'}
                          </button>
                          <button
                            onClick={cancelarEdicion}
                            disabled={loading}
                            className="flex-1 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          }

          const progreso = calcularProgreso();

          return (
            <div className="min-h-screen bg-gray-50 p-4">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-200">
                  <div className="flex justify-between items-center mb-6">
                    <div>
                      <h1 className="text-2xl font-bold text-azul-lgm mb-2">Registro de Medidores</h1>
                      <p className="text-gray-600">Hola, <span className="font-semibold text-verde-lgm">{user.nombre}</span></p>
                    </div>
                    <div className="flex items-center gap-3">
                      {isOnline ? (
                        <span className="flex items-center gap-1 text-green-600 text-sm bg-green-50 px-3 py-1 rounded-full">
                          <Wifi className="w-4 h-4" />
                          {firebaseInitialized ? 'Firebase' : 'Local'}
                        </span>
                      ) : (
                        <span className="flex items-center gap-1 text-orange-600 text-sm bg-orange-50 px-3 py-1 rounded-full">
                          <WifiOff className="w-4 h-4" />
                          Offline
                        </span>
                      )}
                      <button
                        onClick={() => { setUser(null); setView('login'); }}
                        className="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-all transform hover:scale-105"
                      >
                        <LogOut className="w-4 h-4" />
                        Salir
                      </button>
                    </div>
                  </div>

                  {syncStatus && (
                    <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-800">
                      {syncStatus}
                    </div>
                  )}

                  {firebaseError && (
                    <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800">
                      {firebaseError}
                    </div>
                  )}

                  <div className="bg-blue-50 p-4 rounded-xl mb-6 border border-gray-200">
                    <p className="text-sm text-gray-700 mb-2">Progreso de hoy: {progreso.completados} / {progreso.total} locales</p>
                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div
                        className="bg-verde-lgm h-3 rounded-full transition-all duration-500 shadow-lg"
                        style={{ width: `${progreso.porcentaje}%` }}
                      ></div>
                    </div>
                  </div>

                  {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl flex items-start gap-2 mb-4">
                      <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                      <span className="text-sm">{error}</span>
                    </div>
                  )}

                  {success && (
                    <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-xl flex items-start gap-2 mb-4">
                      <CheckCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                      <span className="text-sm">{success}</span>
                    </div>
                  )}

                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Buscar Local o Inquilino
                      </label>
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                        <input
                          type="text"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                          placeholder="Ej: 25, Equindeca, Baños..."
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Seleccionar Local *
                      </label>
                      <select
                        value={selectedLocal}
                        onChange={(e) => setSelectedLocal(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                      >
                        <option value="">-- Seleccione un local --</option>
                        {filteredLocales.map(local => {
                          const hoy = obtenerHoy();
                          const yaRegistrado = registros.find(r => {
                            if (!r.fecha) return false;
                            const fechaRegistro = obtenerFechaLocal(r.fecha);
                            return String(r.local) === String(local.numero) && 
                                   fechaRegistro === hoy;
                          });
                          const etiqueta = local.grupo ? `${local.numero} (Medidor Compartido)` : local.numero;
                          return (
                            <option key={local.numero} value={local.numero} disabled={yaRegistrado}>
                              {etiqueta} - {local.inquilino} {yaRegistrado ? '✓' : ''}
                              {local.ultimaLectura > 0 ? ` (${local.ultimaLectura} m³)` : ''}
                            </option>
                          );
                        })}
                      </select>
                      {searchTerm && filteredLocales.length === 0 && (
                        <p className="text-sm text-gray-500 mt-2">No se encontraron locales</p>
                      )}
                    </div>

                    {selectedLocal && (
                      <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-xl">
                        <p className="text-sm text-yellow-800">
                          <strong>Local {selectedLocal} - {locales.find(l => String(l.numero) === String(selectedLocal))?.inquilino}</strong>
                          <br />
                          Última lectura: {locales.find(l => String(l.numero) === String(selectedLocal))?.ultimaLectura || 0} m³
                          {locales.find(l => String(l.numero) === String(selectedLocal))?.fechaUltimaLectura && (
                            <span className="block text-xs mt-1">
                              Fecha: {new Date(locales.find(l => String(l.numero) === String(selectedLocal)).fechaUltimaLectura).toLocaleDateString()}
                            </span>
                          )}
                        </p>
                      </div>
                    )}

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Lectura del Medidor (m³) *
                      </label>
                      <input
                        type="number"
                        step="0.01"
                        value={lectura}
                        onChange={(e) => setLectura(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                        placeholder="Ej: 1234.56"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Foto del Medidor (opcional)
                      </label>
                      <input
                        id="foto-input"
                        type="file"
                        accept="image/*"
                        capture="environment"
                        onChange={handleFileChange}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                      />
                      {foto && (
                        <div className="mt-4">
                          <img src={foto} alt="Preview" className="w-full max-h-64 object-contain rounded-xl border border-gray-300 shadow-sm" />
                        </div>
                      )}
                    </div>

                    <button
                      onClick={handleSubmit}
                      disabled={loading}
                      className="w-full flex items-center justify-center gap-2 bg-verde-lgm hover:bg-[#7a8560] disabled:bg-gray-400 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                    >
                      <Camera className="w-5 h-5" />
                      {loading ? 'Guardando...' : 'Registrar Lectura'}
                    </button>

                    {!isOnline && (
                      <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                        <p className="text-sm text-yellow-800 text-center">
                          <strong>Modo Offline</strong> - Los registros se guardan localmente y se sincronizarán automáticamente cuando recuperes la conexión.
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white rounded-2xl shadow-xl p-6 border border-gray-200">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Mis Registros de Hoy</h2>
                  <div className="space-y-3">
                    {registros
                      .filter(r => {
                        if (!r.fecha) return false;
                        const fechaRegistro = obtenerFechaLocal(r.fecha);
                        const hoy = obtenerHoy();
                        return r.username === user.username && fechaRegistro === hoy;
                      })
                      .sort(ordenarRegistros) // Ordenar registros del guardia
                      .map(r => (
                        <div key={r.firebaseId || r.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200">
                          <div className="flex-1">
                            <p className="font-medium text-gray-800">{r.local} - {r.inquilino}</p>
                            <p className="text-sm text-gray-600">{r.lectura} m³ - {r.fecha ? new Date(r.fecha).toLocaleTimeString() : 'Hora no disponible'}</p>
                            <p className="text-xs text-gray-500 mt-1">
                              {r.firebaseId ? (
                                <span className="text-green-600">✓ Sincronizado con Firebase</span>
                              ) : (
                                <span className="text-yellow-600">● Guardado localmente (offline)</span>
                              )}
                            </p>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => iniciarEdicion(r)}
                              className="flex items-center gap-1 px-3 py-1 bg-azul-lgm hover:bg-[#1a1f45] text-white rounded-lg text-xs transition-colors"
                            >
                              <Edit className="w-3 h-3" />
                              Editar
                            </button>
                            <button
                              onClick={() => eliminarRegistro(r)}
                              className="flex items-center gap-1 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors"
                            >
                              <Trash className="w-3 h-3" />
                              Eliminar
                            </button>
                          </div>
                        </div>
                      ))}
                    {registros.filter(r => {
                      if (!r.fecha) return false;
                      const fechaRegistro = obtenerFechaLocal(r.fecha);
                      const hoy = obtenerHoy();
                      return r.username === user.username && fechaRegistro === hoy;
                    }).length === 0 && (
                      <p className="text-center text-gray-500 py-4">No has registrado ningún local hoy</p>
                    )}
                  </div>
                </div>

                {/* Modal de Edición para Guardia */}
                {editandoRegistro && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-200">
                      <h3 className="text-xl font-bold text-gray-800 mb-4">Editar Lectura</h3>
                      <div className="space-y-4">
                        <div>
                          <p className="text-sm text-gray-600 mb-2">Local: <span className="font-semibold">{editandoRegistro.local}</span></p>
                          <p className="text-sm text-gray-600 mb-4">Inquilino: <span className="font-semibold">{editandoRegistro.inquilino}</span></p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Nueva Lectura (m³) *
                          </label>
                          <input
                            type="number"
                            step="0.01"
                            value={editLectura}
                            onChange={(e) => setEditLectura(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-verde-lgm focus:border-transparent transition-all"
                            placeholder="Ej: 1234.56"
                          />
                        </div>
                        <div className="flex gap-4 pt-4">
                          <button
                            onClick={guardarEdicion}
                            disabled={loading}
                            className="flex-1 bg-verde-lgm hover:bg-[#7a8560] disabled:bg-gray-400 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105"
                          >
                            {loading ? 'Guardando...' : 'Guardar Cambios'}
                          </button>
                          <button
                            onClick={cancelarEdicion}
                            disabled={loading}
                            className="flex-1 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-400 text-white font-semibold py-3 rounded-xl transition-all transform hover:scale-105"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<MedidorApp />, document.getElementById('root'));
    </script>
</body>
</html>



